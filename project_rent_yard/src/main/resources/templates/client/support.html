<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Há»— trá»£ trá»±c tuyáº¿n</title>
    <th:block th:replace="layout/layout :: library"></th:block>

    <style>
        #chat-box {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: #f9f9f9;
        }

        .msg-user {
            text-align: right;
            margin-bottom: 5px;
        }

        .msg-admin {
            text-align: left;
            margin-bottom: 5px;
        }

        .bubble {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 10px;
            max-width: 70%;
        }

        .user-bubble {
            background: #0d6efd;
            color: white;
        }

        .admin-bubble {
            background: #e9ecef;
        }

        .ack {
            font-size: 12px;
            font-style: italic;
            color: #666;
            text-align: right;
            margin-bottom: 8px;
        }

    </style>
</head>

<body>

<div class="container mt-4">

    <h4>ðŸ’¬ Há»— trá»£ trá»±c tuyáº¿n</h4>

    <div id="chat-box"
         th:data-user-id="${session.user.id}">
    </div>

    <div class="input-group mt-3">
        <input id="message" type="text" class="form-control"
               placeholder="Nháº­p tin nháº¯n...">
        <button class="btn btn-primary" onclick="sendMessage()">Gá»­i</button>
    </div>

</div>

<script src="http://localhost:3000/socket.io/socket.io.js"></script>
<script>
    const socket = io("http://localhost:3000");
    let lastAckEl = null;
    socket.on("message", (msg) => {
        lastAckEl = null;

        showMessage({
            senderRole: "ADMIN",
            content: msg
        });
    });


    function sendMessage() {
        let input = document.getElementById("message");
        let content = input.value.trim();
        if (!content) return;

        showMessage({
            senderRole: "USER",
            content: content
        });

        socket.emit("message", content);
        input.value = "";
    }

    socket.on("ack", () => {
        if (lastAckEl) return;

        let chatBox = document.getElementById("chat-box");
        let ack = document.createElement("div");
        ack.className = "ack";
        ack.innerText = "Ä‘Ã£ nháº­n tin nháº¯n";

        chatBox.appendChild(ack);
        chatBox.scrollTop = chatBox.scrollHeight;

        lastAckEl = ack;
    });



    function showMessage(message) {
        let chatBox = document.getElementById("chat-box");

        let wrapper = document.createElement("div");
        wrapper.className = message.senderRole === 'USER'
            ? 'msg-user'
            : 'msg-admin';

        let bubble = document.createElement("div");
        bubble.className = 'bubble ' +
            (message.senderRole === 'USER'
                ? 'user-bubble'
                : 'admin-bubble');

        bubble.innerText = message.content;

        wrapper.appendChild(bubble);
        chatBox.appendChild(wrapper);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>

</body>
</html>
