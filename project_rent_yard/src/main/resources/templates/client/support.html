<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>H·ªó tr·ª£ tr·ª±c tuy·∫øn</title>
    <th:block th:replace="layout/layout :: library"></th:block>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>

    <style>
        #chat-box {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: #f9f9f9;
        }

        .msg-user {
            text-align: right;
            margin-bottom: 5px;
        }

        .msg-admin {
            text-align: left;
            margin-bottom: 5px;
        }

        .bubble {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 10px;
            max-width: 70%;
        }

        .user-bubble {
            background: #0d6efd;
            color: white;
        }

        .admin-bubble {
            background: #e9ecef;
        }
    </style>
</head>

<body>

<div class="container mt-4">

    <h4>üí¨ H·ªó tr·ª£ tr·ª±c tuy·∫øn</h4>

    <div id="chat-box"
         th:data-user-id="${session.user.id}">
    </div>

    <div class="input-group mt-3">
        <input id="message" type="text" class="form-control"
               placeholder="Nh·∫≠p tin nh·∫Øn...">
        <button class="btn btn-primary" onclick="sendMessage()">G·ª≠i</button>
    </div>

</div>

<script>
    // ===== SETUP =====
    let socket = new SockJS('/ws');
    let stompClient = Stomp.over(socket);

    let userId = document.getElementById("chat-box").dataset.userId;

    stompClient.connect({}, function () {

        // User nh·∫≠n tin nh·∫Øn c·ªßa ri√™ng m√¨nh
        stompClient.subscribe('/topic/chat.user.' + userId, function (msg) {
            let message = JSON.parse(msg.body);
            showMessage(message);
        });

    });

    // ===== SEND MESSAGE =====
    function sendMessage() {
        let input = document.getElementById("message");
        let content = input.value.trim();

        if (content === "") return;

        // 1Ô∏è‚É£ HI·ªÇN TH·ªä NGAY TR√äN UI
        showMessage({
            senderRole: "USER",
            content: content
        });

        // 2Ô∏è‚É£ G·ª¨I L√äN SERVER
        stompClient.send("/app/chat.send", {}, JSON.stringify({
            senderId: userId,
            receiverId: 1,
            senderRole: "USER",
            content: content
        }));

        input.value = "";
    }

    // ===== SHOW MESSAGE =====
    function showMessage(message) {
        let chatBox = document.getElementById("chat-box");

        let wrapper = document.createElement("div");
        wrapper.className = message.senderRole === 'USER'
            ? 'msg-user'
            : 'msg-admin';

        let bubble = document.createElement("div");
        bubble.className = 'bubble ' +
            (message.senderRole === 'USER'
                ? 'user-bubble'
                : 'admin-bubble');

        bubble.innerText = message.content;

        wrapper.appendChild(bubble);
        chatBox.appendChild(wrapper);

        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>

</body>
</html>
