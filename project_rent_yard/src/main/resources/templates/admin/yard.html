<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="admin/layout :: layout(~{::section}, 'Qu·∫£n l√Ω S√¢n')">

<section>
    <h3>Qu·∫£n l√Ω s√¢n </h3>

    <div class="card">
        <div class="card-body">
            <form th:action="@{/admins/yard}" method="get" class="row g-3 mb-4">

                <div class="col-md-3">
                    <label class="form-label">Lo·∫°i s√¢n</label>
                    <select name="fieldType" class="form-select">
                        <option value="">-- T·∫•t c·∫£ --</option>
                        <option value="Field5"
                                th:selected="${param.fieldType != null and param.fieldType[0] == 'Field5'}">
                            S√¢n 5
                        </option>

                        <option value="Field7"
                                th:selected="${param.fieldType != null and param.fieldType[0] == 'Field7'}">
                            S√¢n 7
                        </option>

                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Tr·∫°ng th√°i</label>
                    <select name="fieldStatus" class="form-select">
                        <option value="">-- T·∫•t c·∫£ --</option>
                        <option value="AVAILABLE"
                                th:selected="${param.fieldStatus != null and param.fieldStatus[0] == 'AVAILABLE'}">
                            Ho·∫°t ƒë·ªông
                        </option>

                        <option value="BOOKED"
                                th:selected="${param.fieldStatus != null and param.fieldStatus[0] == 'BOOKED'}">
                            ƒê√£ ƒë·∫∑t
                        </option>

                        <option value="MAINTENANCE"
                                th:selected="${param.fieldStatus != null and param.fieldStatus[0] == 'MAINTENANCE'}">
                            B·∫£o tr√¨
                        </option>

                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Gi√° t·ª´</label>
                    <input type="number" name="minPrice" class="form-control"
                           th:value="${param.minPrice}">
                </div>

                <div class="col-md-3">
                    <label class="form-label">Gi√° ƒë·∫øn</label>
                    <input type="number" name="maxPrice" class="form-control"
                           th:value="${param.maxPrice}">
                </div>

                <div class="col-12">
                    <button class="btn btn-primary">L·ªçc</button>
                    <a th:href="@{/admins/yard}" class="btn btn-secondary">Reset</a>
                </div>
            </form>
        </div>
    </div>

    <table class="table table-striped">
        <thead>
        <tr>
            <td>T√™n s√¢n</td>
            <td>Lo·∫°i s√¢n</td>
            <td>Tr·∫°ng th√°i</td>
            <td>Gi√°</td>
            <td>Gi·ªù tr·ªëng</td>
            <td>H√†nh ƒë·ªông</td>
        </tr>
        </thead>
        <tbody>
        <tr th:each="field:${fields}">
            <td th:text="${field.name}"></td>
            <td th:text="${field.fieldType}"></td>
            <td th:text="${field.status}"></td>
            <td th:text="${field.price}"></td>
            <td>

                <div th:if="${field.status.name() == 'AVAILABLE'}"
                     class="d-flex flex-wrap gap-1">

                    <a th:each="slot : ${slotMap[field.id]}"
                       th:if="${slot.available}"
                       class="btn btn-sm btn-success book-slot"
                       th:data-field-id="${field.id}"
                       th:data-start="${slot.startTime}"
                       th:text="${slot.startTime.minusHours(1)}">
                    </a>

                </div>

                <span th:if="${field.status.name() == 'BOOKED'}"
                      class="badge bg-danger fs-6">
                    ‚õî ƒê√£ full
                </span>


                <span th:if="${field.status.name() == 'MAINTENANCE'}"
                      class="badge bg-warning text-dark fs-6">
                    üîß ƒêang b·∫£o tr√¨
                </span>

            </td>

            <td>
                <a class="btn btn-primary"> Full </a>
                <a class="btn btn-danger"> Cancel </a>
            </td>

        </tr>
        </tbody>

    </table>
    <div class="alert alert-warning" th:if="${fields.size() == 0}">
        Kh√¥ng c√≥ s√¢n ph√π h·ª£p
    </div>

    <nav th:if="${fieldPage.totalPages > 1}">
        <ul class="pagination justify-content-center">

            <!-- Prev -->
            <li class="page-item" th:classappend="${fieldPage.first} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/admins/yard(
                       page=${fieldPage.number - 1},
                       fieldType=${param.fieldType},
                       fieldStatus=${param.fieldStatus},
                       minPrice=${param.minPrice},
                       maxPrice=${param.maxPrice}
                   )}">
                    &laquo;
                </a>
            </li>

            <!-- Page numbers -->
            <li class="page-item"
                th:each="i : ${#numbers.sequence(0, fieldPage.totalPages - 1)}"
                th:classappend="${i == fieldPage.number} ? 'active'">

                <a class="page-link"
                   th:text="${i + 1}"
                   th:href="@{/admins/yard(
                       page=${i},
                       fieldType=${param.fieldType},
                       fieldStatus=${param.fieldStatus},
                       minPrice=${param.minPrice},
                       maxPrice=${param.maxPrice}
                   )}">
                </a>
            </li>

            <!-- Next -->
            <li class="page-item" th:classappend="${fieldPage.last} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/admins/yard(
                       page=${fieldPage.number + 1},
                       fieldType=${param.fieldType},
                       fieldStatus=${param.fieldStatus},
                       minPrice=${param.minPrice},
                       maxPrice=${param.maxPrice}
                   )}">
                    &raquo;
                </a>
            </li>

        </ul>
    </nav>

    <!-- Modal x√°c nh·∫≠n -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">X√°c nh·∫≠n ƒë·∫∑t s√¢n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    B·∫°n c√≥ ch·∫Øc mu·ªën ƒë·∫∑t khung gi·ªù n√†y kh√¥ng?
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        H·ªßy
                    </button>
                    <button type="button" class="btn btn-primary" id="confirmBooking">
                        X√°c nh·∫≠n
                    </button>
                </div>

            </div>
        </div>
    </div>

    <script>
        let selectedFieldId = null;
        let selectedStartTime = null;

        document.addEventListener("DOMContentLoaded", function () {

            document.querySelectorAll(".book-slot").forEach(button => {

                button.addEventListener("click", function () {

                    selectedFieldId = this.dataset.fieldId;
                    selectedStartTime = this.dataset.start;

                    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
                    modal.show();
                });

            });

        });
    </script>

    <script>
        document.getElementById("confirmBooking")
            .addEventListener("click", function () {

                fetch("/admins/api/book", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        fieldId: selectedFieldId,
                        startTime: selectedStartTime
                    })
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("L·ªói t·∫°o booking");
                        }
                        return response.json();
                    })
                    .then(data => {
                        location.reload();
                    })
                    .catch(error => {
                        alert("C√≥ l·ªói x·∫£y ra!");
                        console.error(error);
                    });

            });
    </script>


</section>

</html>
