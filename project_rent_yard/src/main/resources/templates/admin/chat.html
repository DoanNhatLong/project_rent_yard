<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin Chat</title>

    <th:block th:replace="layout/layout :: library"></th:block>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>

    <style>
        #chat-box {
            height: 400px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
            background: #f9f9f9;
        }
        .user {
            text-align: left;
            margin: 5px 0;
        }
        .admin {
            text-align: right;
            margin: 5px 0;
        }
        .bubble {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 10px;
            max-width: 70%;
        }
        .user .bubble {
            background: #e9ecef;
        }
        .admin .bubble {
            background: #0d6efd;
            color: white;
        }
    </style>
</head>

<body>
<div class="container">
    <h3>üí¨ Admin Support Chat</h3>

    <!-- USER ƒêANG CHAT -->
    <div id="current-user"
         style="margin-bottom:10px; font-weight:bold;">
        ƒêang chat v·ªõi: ---
    </div>

    <!-- CHAT BOX -->
    <div id="chat-box"></div>

    <!-- INPUT -->
    <div style="margin-top:10px">
        <input id="message" placeholder="Nh·∫≠p tin nh·∫Øn..." style="width:80%">
        <button onclick="send()">G·ª≠i</button>
    </div>

</div>



<script>
    const ADMIN_ID = 1;               // admin id (hardcode local)
    let currentUserId = null;         // user ƒëang chat
    const userCache = {};             // userId -> userName

    let socket = new SockJS('/ws');
    let stompClient = Stomp.over(socket);

    stompClient.connect({}, function () {

        stompClient.subscribe('/topic/chat.user.' + ADMIN_ID, function (msg) {
            let message = JSON.parse(msg.body);

            // b·ªè qua ACK t·ª´ server
            if (message.senderRole === "SERVER") return;

            currentUserId = message.senderId;

            // ch∆∞a c√≥ name -> g·ªçi API
            if (!userCache[currentUserId]) {
                fetch('/api/users/' + currentUserId)
                    .then(res => res.json())
                    .then(user => {
                        userCache[currentUserId] = user.name;
                        updateHeader(user.name, user.id);
                    });
            } else {
                updateHeader(userCache[currentUserId], currentUserId);
            }

            showMessage(message.content, 'user');
        });
    });

    function send() {
        let content = document.getElementById("message").value.trim();
        if (!content || !currentUserId) return;

        let message = {
            senderId: ADMIN_ID,
            receiverId: currentUserId,
            senderRole: "ADMIN",
            content: content
        };

        showMessage(content, 'admin');
        stompClient.send("/app/chat.send", {}, JSON.stringify(message));

        document.getElementById("message").value = "";
    }

    function updateHeader(name, id) {
        document.getElementById("current-user").innerText =
            `ƒêang chat v·ªõi: ${name} (ID: ${id})`;
    }

    function showMessage(content, type) {
        let wrapper = document.createElement("div");
        wrapper.className = type;

        let bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.innerText = content;

        wrapper.appendChild(bubble);
        document.getElementById("chat-box").appendChild(wrapper);
        document.getElementById("chat-box").scrollTop =
            document.getElementById("chat-box").scrollHeight;
    }
</script>

</body>
</html>
